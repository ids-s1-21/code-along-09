---
title: "Code-along, Week 09: Modelling pubs, continued"
author: "Alex Homer"
date: "18 November 2021"
output: github_document
editor_options: 
  chunk_output_type: console
---

This week's data come from the UK's [Office for National Statistics](https://www.ons.gov.uk/) (ONS).  We will be using the following datasets:

* [Public houses and bars by local authority](https://www.ons.gov.uk/businessindustryandtrade/business/activitysizeandlocation/datasets/publichousesandbarsbylocalauthority) (Copyright date: 2018)
* [Estimates of the population for the UK, England and Wales, Scotland and Northern Ireland ](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland) (Copyright date: 2021)
* [Earnings and hours worked, place of residence by local authority: ASHE Table 8](https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/placeofresidencebylocalauthorityashetable8) (Copyright date: 2021)
* [Standard Area Measurements (2018) for Administrative Areas in the United Kingdom](https://geoportal.statistics.gov.uk/datasets/standard-area-measurements-2018-for-administrative-areas-in-the-united-kingdom/about) (Copyright date: 2019)
* [Life Expectancy by Local Authority](https://www.ons.gov.uk/datasets/life-expectancy-by-local-authority/editions/time-series/versions/1) (Copyright date: 2020)
* [Local Authority Districts (December 2018) Boundaries UK BFC](https://geoportal.statistics.gov.uk/maps/fef73aeaf13c417dadf2fc99abcf8eef/about) (Copyright date: 2019)

The data are subject to crown copyright and database rights and are used under the [Open Government Licence v3.0](https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/).  In addition the boundary file contains OS data Â© Crown copyright and database right 2019.

```{r load-packages, message = FALSE}
library(tidyverse)
library(tidymodels)
library(sf)
library(here)
```

## Read data

I've already done some of the cleanup and joining in advance to save time in the live session.  You can see the cleanup script in the "data" folder of this repo.

```{r read-data, message = FALSE}
pubs_data <- readRDS(here("data/pubs-final.rds"))
```

Because I put these data together, let's write a data dictionary:

- `area_code`: the [ONS area code](https://en.wikipedia.org/wiki/ONS_coding_system) for each district
- `area_name`: the name of each district
- `num_pubs`: the number of pubs in each district (2018)
- `pop`: the population of each district (2018)
- `pubs_per_capita`: the number of pubs per person (2018; obtained by dividing `num_pubs` by `pop`)
- `country`: which UK nation each district belongs to (England, Northern Ireland, Scotland or Wales)
- `median_pay_2017`: the median weekly pay, in pounds sterling, for residents of each district (2017)
- `area_sqkm`: the area, in square kilometres, of each district to mean high water level
- `coastal`: categorical variable, with three values:
  - `"Inland"`, for districts in Great Britain whose total extent is equal to their extent to mean high water level
  - `"Coastal"`, for districts in Great Britain whose total extent is greater than their extent to mean high water level
  - `NA`, for districts in Northern Ireland (the data in NI appear to have been measured differently, so all districts have equal values for their total extent and extent to mean high water)
- `pop_dens`: the population density (people per square kilometre) of each district (2018; obtained by dividing `pop` by `area_sqkm`)
- `life_exp_female`, `life_exp_male`: the life expectancy at birth of people born in each district, broken down by binary sex (2016--2018) ^[Sex and gender are, of course, more complicated than that, but the ONS only gives "male" and "female" figures; in the UK all birth certificates have one of these two options recorded.]

It's worth noting that the `coastal` variable doesn't necessarily agree with intuitive definitions of the words "coastal" and "inland", because of the effect of tidal rivers on the data...

```{r map, cache = TRUE, eval = FALSE, fig.height = 10}
shape_data <- read_sf(
  here(
    "data/map/Local_Authority_Districts_(December_2018)_Boundaries_UK_BFC.shp"
  )
)

shape_data %>%
  rename(area_code = lad18cd) %>%
  left_join(pubs_data, by = "area_code") %>%
  filter(!str_detect(area_code, "^N")) %>%
  ggplot(aes(fill = coastal)) +
  geom_sf(colour = "black") +
  scale_fill_manual(values = c(Coastal = "turquoise", Inland = "darkGreen")) +
  labs(fill = "Area type") +
  theme_minimal()
```


## EDA

```{r glimpse}
glimpse(pubs_data)
```

```{r see-NAs}
pubs_data %>%
  summarise(across(everything(), ~sum(is.na(.)), .names = "NAs_{.col}")) %>%
  select_if(~ sum(.) > 0)

which_nas <- function(var_name) {
  pubs_data %>%
    filter(is.na((!!as.symbol(var_name)))) %>%
    pull(area_name)
}

which_nas("median_pay_2017")
which_nas("coastal")
which_nas("life_exp_female")
which_nas("life_exp_male")
```

```{r ggpairs}
pubs_data %>%
  filter(!(area_name %in% c("City of London", "Isles of Scilly"))) %>%
  select(-c(area_code, area_name, coastal, num_pubs, pop)) %>%
  GGally::ggpairs(aes(colour = country), alpha = 0.5)
```

```{r pay-model}
pubs_reduced <- pubs_data %>%
  filter(!(area_name %in% c("City of London", "Isles of Scilly")))

mod <- linear_reg() %>%
  set_engine("lm") %>%
  fit(pubs_per_capita ~ median_pay_2017, data = pubs_reduced)

tidy(mod)
glance(mod)
```